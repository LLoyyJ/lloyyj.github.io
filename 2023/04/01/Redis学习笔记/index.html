<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis学习笔记 | LLoyyj's blog</title><meta name="keywords" content="Redis"><meta name="author" content="LLoyyj"><meta name="copyright" content="LLoyyj"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis（单进程单线程）RDB &amp; AOF机制 RDB：Redis Database 在指定时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储 优点： 整个redis数据库将只包含一个文件dump.rdb，方便持久化 容灾性好，方便备份 性能最大化，fork子进程完成写操作，主进程继续执行命令。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis学习笔记">
<meta property="og:url" content="http://lloyyj.github.io/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="LLoyyj&#39;s blog">
<meta property="og:description" content="Redis（单进程单线程）RDB &amp; AOF机制 RDB：Redis Database 在指定时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储 优点： 整个redis数据库将只包含一个文件dump.rdb，方便持久化 容灾性好，方便备份 性能最大化，fork子进程完成写操作，主进程继续执行命令。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg">
<meta property="article:published_time" content="2023-04-01T03:27:41.000Z">
<meta property="article:modified_time" content="2023-04-18T13:19:27.747Z">
<meta property="article:author" content="LLoyyj">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/01/11/x4cowVP16vkygHB.png"><link rel="canonical" href="http://lloyyj.github.io/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#5F9EA0&quot;,&quot;paginator&quot;:&quot;#B0E0E6&quot;,&quot;button_hover&quot;:&quot;#DED3CD&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;,&quot;scrollbar_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: LLoyyj","link":"Link: ","source":"Source: LLoyyj's blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-04-18 21:19:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://s2.loli.net/2023/01/11/1NsbGvmfukWXBQM.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/01/13/HgqerZ84sb67c2G.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LLoyyj's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-04-01T03:27:41.000Z" title="Created 2023-04-01 11:27:41">2023-04-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-04-18T13:19:27.747Z" title="Updated 2023-04-18 21:19:27">2023-04-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%90%8E%E7%AB%AF/">Java后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>17min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis（单进程单线程）"><a href="#Redis（单进程单线程）" class="headerlink" title="Redis（单进程单线程）"></a>Redis（单进程单线程）</h1><h3 id="RDB-amp-AOF机制"><a href="#RDB-amp-AOF机制" class="headerlink" title="RDB &amp; AOF机制"></a>RDB &amp; AOF机制</h3><ul>
<li>RDB：Redis Database<ul>
<li>在指定时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储</li>
<li>优点：<ol>
<li>整个redis数据库将只包含一个文件dump.rdb，方便持久化</li>
<li>容灾性好，方便备份</li>
<li>性能最大化，fork子进程完成写操作，主进程继续执行命令。所以是IO最大化。保证了redis的高性能</li>
<li>相对于数据集大时，比AOF的启动效率更高</li>
</ol>
</li>
<li>缺点：<ol>
<li>数据安全性低，RDB时间隔一段时间进行持久化，若在中间间隔的时间redis发生故障，会发生数据丢失（所以rdb更适合数据要求不严谨的时候）</li>
<li>RDB通过fork子进程协助完成数据持久化工作，so如果数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是一秒钟</li>
</ol>
</li>
</ul>
</li>
<li>AOF：Append Only File<ul>
<li>以日志的形式记录服务器所处理的每一个写、删除操作（查询不会记录），以文本的方式记录，可以打开文件看到详细的操作记录</li>
<li>优点：<ol>
<li>数据安全，redis提供了三种同步策略（每秒同步、每修改同步、不同步）。每秒同步是异步完成的，效率很高，但一旦系统宕机，那么这一秒内修改的数据将会丢失；而每修改同步可以视为同步持久化，每次发生的数据变化都会被立即记录到磁盘中</li>
<li>append模式写文件，中途服务器宕机也不会破坏已经存在的内容，可以通过redis-check-aof工具解决数据一致性的问题</li>
<li>AOF机制的rewrite模式，定期对AOF文件进行重写，合并操作，以达到压缩的目的</li>
</ol>
</li>
<li>缺点：<ol>
<li>AOF文件比RDB大，且恢复速度慢（全部重新操作一遍）</li>
<li>数据集大的时候，比RDB启动效率低</li>
<li>运行效率没有RDB高（因为追加）</li>
</ol>
</li>
</ul>
</li>
<li>AOF文件比RDB更新频率高，优先使用AOF还原数据，AOF比RDB安全也更大，但RDB性能更好，如果两个都配了会优先加载AOF</li>
</ul>
<h3 id="过期键的删除策略"><a href="#过期键的删除策略" class="headerlink" title="过期键的删除策略"></a>过期键的删除策略</h3><ul>
<li>惰性过期：访问时判断是否过期再进行清除——最大化节省CPU资源，但占内存</li>
<li>定时过期：给key设置过期时间，过期就删除（redis没用）</li>
<li>定期过期：每隔一段时间，扫描一定数量的数据库的expires字典（保存了所有设置了过期时间的key的过期时间数据，其中key是指向某个键的指针，value是该键的毫秒精度的UNIX时间戳表示的过期时间）中一定数量的key，过期就清楚——通过调整定时扫描的时间间隔和每次扫描的限定耗时，可以在不同情况下使得CPU和内存资源达到最优的平衡效果</li>
<li>redis中同时使用惰性过期和定期过期两种策略</li>
</ul>
<h3 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h3><ul>
<li>Redis基于Reactor（响应）模式开发了网络事件处理器，这个处理器叫做文件事件处理器file event handler。这个文件事件处理器，它是单线程的，所以Redis 才叫做单线程的模型，它采用lO多路复用机制来同时监听多个Socket，根据Socket上的事件类型来选择对应的事件处理器来处理这个事件。可以实现高性能的网络通信模型，又可以跟内部其他单线程的模块进行对接，保证了Redis 内部的线程模型的简单性。</li>
<li>文件事件处理器的结构包含4个部分:多个Socket、lO多路复用程序、文件事件分派器以及事件处理器（命令请求处理器、命令回复处理器、连接应答处理器等）。<br>多个Socket可能并发的产生不同的操作，每个操作对应不同的文件事件，但是IO多路复用程序会监听多个Socket，会将Socket放入一个队列中排队，每次从队列中取出一个Socket给事件分派器，事件分派器把Socket给对应的事件处理器。然后一个Socket的事件处理完之后，IO多路复用程序才会将队列中的下一个Socket给事件分派器。文件事件分派器会根据每个Socket当前产生的事件，来选择对应的事件处理器来处理。</li>
<li>单线程快的原因:<br>1）纯内存操作<br>2）核心是基于非阻塞的IO多路复用机制<br>3）单线程反而避免了多线程的频繁上下文切换带来的性能问题</li>
</ul>
<h3 id="缓存雪崩、缓存穿透、缓存击穿"><a href="#缓存雪崩、缓存穿透、缓存击穿" class="headerlink" title="缓存雪崩、缓存穿透、缓存击穿"></a>缓存雪崩、缓存穿透、缓存击穿</h3><ul>
<li>缓存雪崩是指缓存同一时间大面积的失效 &#x2F; 缓存重启，所以，后面的请求都会落到数据库上，造成数据库短时间内承受大量请求而崩掉。<ul>
<li>解决方案:<ul>
<li>缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生</li>
<li>给每一个缓存数据增加相应的缓存标记，记录缓存是否失效，如果缓存标记失效，则更新数据缓存（一直监控，消耗性能）</li>
<li>缓存预热（将热点数据加载到缓存后再启动服务）</li>
<li>互斥锁（缓存失效去查数据库时，锁住这个键，查完回来再解锁，防止大量请求）</li>
</ul>
</li>
</ul>
</li>
<li>缓存穿透是指缓存和数据库中都没有的数据，导致所有的请求都落到数据库上，造成数据库短时间内承受大量请求而崩掉。<ul>
<li>解决方案:<ul>
<li>接口层增加校验，如用户鉴权校验，id做基础校验，id&lt;&#x3D;O的直接拦截（业务层逻辑，参数校验）;</li>
<li>从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒(设置太长会导致正常情况也没法使用)。这样可以防止攻击用户反复用同一个id暴力攻击。</li>
<li>采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的 bitmap中，一个一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层存储系统的查询压力（但bitmap中存在数据不一定存在）</li>
</ul>
</li>
</ul>
</li>
<li>缓存击穿是指缓存中没有但数据库中有的数据（一般是缓存时间到期)，这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力。和缓存雪崩不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。<ul>
<li>解决方案<ul>
<li>设置热点数据永远不过期</li>
<li>加互斥锁（只让一个线程去查数据库，让其他线程CAS（自旋？），更新缓存）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="事务实现——保证ACID"><a href="#事务实现——保证ACID" class="headerlink" title="事务实现——保证ACID"></a>事务实现——保证ACID</h3><ol>
<li><p><strong>事务开始</strong></p>
<ul>
<li>MULTI命令的执行，标识着一个事务的开始。MULTI命令会将客户端状态的flags属性中打开REDTS_MLTI标识来完成的。</li>
</ul>
</li>
<li><p><strong>命令入队</strong></p>
<ul>
<li><p>当一个客户端切换到事务状态之后，服务器会根据这个客户端发送来的命令来执行不同的操作。如果客户端发送的命令为MULTI、EXEC、WATCH、DISCARD中的一个，立即执行这个命令，否则将命令放入一个事务队列里面，然后向客户端返回QUEUED回复</p>
<ul>
<li>如果客户端发送的命令为EXEC、DISCARD、WATCH、MULTI四个命令的其中一个，那么服务器立即执行这个命令。</li>
<li>如果客户端发送的是四个命令以外的其他命令，那么服务器并不立即执行这个命令。首先检查此命令的格式（语法）是否正确：<ul>
<li>如果不正确，服务器会在客户端状态(redisclient)的flags属性关闭REDIS_MULTI标识，并且返回错误信息给客户端。</li>
<li>如果正确，将这个命令放入一个事务队列里面，然后向客户端返回QUEUED回复</li>
</ul>
</li>
</ul>
</li>
<li><p>事务队列是按照FIFO的方式保存入队的命令</p>
</li>
</ul>
</li>
<li><p><strong>事务执行</strong></p>
<ul>
<li><p>客户端发送EXEC命令，服务器执行EXEC命令逻辑。</p>
<ul>
<li>如果客户端状态的flags属性不包含REDIS_MULTI标识，或者包含REDIS_DIRTY_CAS或者REDIS_DIRTY_EXEC标识，那么就直接取消事务的执行。</li>
<li>否则客户端处于事务状态（flags有REDIS_MULTI标识)，服务器会遍历客户端的事务队列，然后执行事务队列中的所有命令，最后将返回结果全部返回给客户端;</li>
</ul>
</li>
<li><p>Redis不支持事务回滚机制，但是它会检查每一个事务中的命令是否错误。</p>
</li>
<li><p>Redis事务不支持检查那些程序员自己逻辑错误（例如对 String类型的数据库键执行对HashMap类型的操作）</p>
</li>
</ul>
</li>
</ol>
<ul>
<li>WATCH命令是一个乐观锁，可以为Redis事务提供check-and-set （CAS）行为。可以监控一个或多个键，一旦其中有一个键被修改（或删除），之后的事务就不会执行，监控一直持续到EXEC命令。</li>
<li>MULTI命令用于<strong>开启一个事务</strong>，它总是返回OK。MULTI执行之后，客户端可以继续向服务器发送任意多条命令，这些命令不会立即被执行，而是被放到一个队列中，当EXEC命令被调用时，所有队列中的命令才会被执行。</li>
<li>EXEC：执行所有事务块内的命令。返回事务块内所有命令的返回值，按命令执行的先后顺序排列。当操作被打断时，返回空值nil 。</li>
<li>通过调用DISCARD，客户端可以清空事务队列，并放弃执行事务，并且客户端会从事务状态中退出。 </li>
<li>UNWATCH命令可以取消watch对所有key的监控。</li>
</ul>
<h3 id="Redis集群方案"><a href="#Redis集群方案" class="headerlink" title="Redis集群方案"></a>Redis集群方案</h3><ul>
<li><p><strong>主从</strong>（互为主从）</p>
<ul>
<li><p>全量复制:</p>
<ol>
<li>主节点通过bgsave命令fork子进程进行RDB（全量数据快照文件）持久化，该过程是非常消耗CPU、内存(页表复制)、硬盘IO的</li>
<li>主节点通过网络将RDB文件发送给从节点，对主从节点的带宽都会带来很大的消耗</li>
<li>从节点清空老数据、载入新RDB文件的过程是阻塞的，无法响应客户端的命令;如果从节点执行bgrewriteaof（AOF），也会带来额外的消耗</li>
</ol>
</li>
<li><p>部分复制:</p>
<ol>
<li>复制偏移量：执行复制的双方，主从节点分别会维护一个复制偏移量offset（不一致以主为主）</li>
<li>复制积压缓冲区：主节点内部维护了一个固定长度的、先进先出(FIFO)队列作为复制积压缓冲区，当主从节点offset的差距过大超过缓冲区长度时，将无法执行部分复制，只能执行全量复制。</li>
<li>服务器运行ID(runid)：每个Redis节点，都有其运行ID，运行ID由节点在启动时自动生成，主节点会将自己的运行ID发送给从节点，从节点会将主节点的运行ID存起来。从节点Redis断开重连的时候，就是根据运行ID来判断同步的进度：</li>
</ol>
<ul>
<li>如果从节点保存的runid与主节点现在的runid相同，说明主从节点之前同步过，主节点会继续尝试使用部分复制(到底能不能部分复制还要看offset和复制积压缓冲区的情况);</li>
<li>如果从节点保存的runid与主节点现在的runid不同，说明从节点在断线前同步的Redis节点并不是当前的主节点，只能进行全量复制。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>哨兵模式</strong>（基于主从模式）——sentinel，哨兵是redis集群中非常重要的一个组件，主要有以下功能：</p>
<ul>
<li><p>集群监控：负责监控redis master和slave进程是否正常工作。</p>
</li>
<li><p>消息通知：如果某个redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员</p>
</li>
<li><p>故障转移：如果master node挂掉了，会自动转移到slave node 上。</p>
</li>
<li><p>配置中心：如果故障转移发生了，通知client客户端新的master地址。</p>
</li>
</ul>
<blockquote>
<p>哨兵用于实现redis集群的高可用本身也是分布式的，作为一个哨兵集群去运行互相协同工作。</p>
</blockquote>
<ul>
<li>故障转移时，判断一个master node是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举</li>
<li>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的</li>
<li>哨兵通常需要3个实例，来保证自己的健壮性。</li>
<li>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证redis集群的高可用性。</li>
<li>对于哨兵+ redis主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演练。</li>
</ul>
</li>
<li><p><strong>Redis Cluster</strong>是一种服务端Sharding（服务端分片——服务端决定key分配到哪个节点）技术，3.0版本开始正式提供。采用slot(槽)的概念，一共分成16384个槽。将请求发送到任意节点，接收到请求的节点会将查询请求发送到正确的节点上执行</p>
<ul>
<li>方案说明<ul>
<li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽(哈希值)区间的数据，默认分配了16384个槽位</li>
<li>每份数据分片会存储在多个互为主从的多节点上</li>
<li>数据写入先写主节点，再同步到从节点(支持配置为阻塞同步)</li>
<li>同一分片多个节点间的数据不保持强一致性</li>
<li>读取数据时，当客户端操作的key没有分配在该节点上时，redis会返回转向指令，指向正确的节点</li>
<li>扩容时需要需要把旧节点的数据迁移一部分到新节点</li>
<li>在redis cluster架构下，每个redis要放开两个端口号，比如一个是6379，另外一个就是加1w的端口号，比如16379。</li>
</ul>
</li>
</ul>
<blockquote>
<p>16379端口号是用来进行节点间通信的，也就是cluster bus的通信，用来进行故障检测、配置更新、故障转移授权。cluster bus 用了另外一种二进制的协议，gossip 协议，用于节点间进行高效的数据交换，占用更少的网络带宽和处理时间。</p>
</blockquote>
<ul>
<li>优点<ul>
<li>无中心架构，支持动态扩容，对业务透明</li>
<li>具备Sentinel的监控和自动Failover(故障转移)能力</li>
<li>客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可</li>
<li>高性能，客户端直连redis服务，免去了proxy代理的损耗</li>
</ul>
</li>
<li>缺点<ul>
<li>运维也很复杂，数据迁移需要人工干预</li>
<li>只能使用0号数据库（默认11个数据库）</li>
<li>不支持批量操作（pipeline管道操作）</li>
<li>分布式逻辑和存储模块耦合等</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Redis Sharding</strong>是Redis Cluster出来之前，业界普遍使用的多Redis实例集群方法（客户端分片——客户端决定key分配到哪个节点）。其主要思想是采用哈希算法将Redis数据的key进行散列，通过hash函数，特定的key会映射到特定的Redis节点上。Java redis客户端驱动jedis，支持Redis Sharding功能，即Shardedjedis以及结合缓存池的ShardedJedisPool</p>
<ul>
<li>优点——优势在于非常简单，服务端的Redis实例彼此独立，相互无关联，每个Redis实例像单服务器一样运行，非常容易线性扩展，系统的灵活性很强</li>
<li>缺点<ul>
<li>由于sharding处理放到客户端，规模进一步扩大时给运维带来挑战；</li>
<li>客户端sharding不支持动态增删节点。服务端Redis实例群拓扑结构有变化时，每个客户端都需要更新调整；</li>
<li>连接不能共享，当应用规模增大时，资源浪费制约优化</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ul>
<li><code>MULTI</code>——开启事务</li>
<li><code>EXEC</code>——执行事务中的命令</li>
<li><code>DISCARD</code>——放弃组队</li>
<li><code>WATCH</code>——监视键值对，使EXEC有条件的执行（当所有被监视的键值对都没有被修改时，正常执行操作）</li>
</ul>
<h2 id="事务冲突"><a href="#事务冲突" class="headerlink" title="事务冲突"></a>事务冲突</h2><h2 id="悲观锁-amp-乐观锁"><a href="#悲观锁-amp-乐观锁" class="headerlink" title="悲观锁&amp;乐观锁"></a>悲观锁&amp;乐观锁</h2><blockquote>
<p>乐观锁：（CAS）做操作时比较自己&amp;数据库中的版本号，较新时才可进行操作</p>
</blockquote>
<p>redis中的乐观锁：WATCH命令，执行前监视的键值对被修改过则不执行事务内容</p>
<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><blockquote>
<p>由主线程fork一个子进程执行持久化操作</p>
</blockquote>
<blockquote>
<p>由于Redis是内存数据库，所以redis进程退出或是重启后，会导致数据丢失的问题 —— 持久化以保存数据</p>
</blockquote>
<blockquote>
<p>推荐同时使用AOF、RDB两种方式进行持久化，如果仅使用AOF，文件体积较大，恢复比较慢；而单使用RDB则有丢失数据的风险。</p>
</blockquote>
<h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><ul>
<li>使用<code>dump.rdb</code>文件（经过压缩的二进制文件 &#x2F; 快照文件），存储数据</li>
<li>自动持久化 —— 配置文件中设置 save m n<ul>
<li>m时间内，修改的键数量大于n个时</li>
<li><code>serverCron函数</code>：监视（100毫秒间隔）</li>
<li><code>dirty计数器</code>：每次修改状态时加一</li>
<li><code>lastsave时间戳</code>：记录上次持久化的时间</li>
</ul>
</li>
<li>手动持久化的两个命令：<ul>
<li><code>SAVE</code> —— 同步、阻塞其他进程（目前很少使用，不建议）</li>
<li><code>BGSAVE</code> —— 异步执行 ，此时如果有SAVE或BGSAVE命令请求，会拒绝，因为使用同一函数，会发生竞争情况；如果有重写请求会推迟重写命令的执行（但相反情况时，会进行拒绝）</li>
</ul>
</li>
<li>过程：主进程fork一个子进程，主进程继续执行命令，子进程将内存中的数据写入硬盘中临时的rdb文件后替换之前的文件</li>
<li>优点：体积小、快</li>
<li>缺点：不实时、可能会丢失大量的数据</li>
</ul>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><blockquote>
<p>优先级大于RDB方法</p>
</blockquote>
<ul>
<li>使用<code>aof文件</code>存储，存储命令</li>
<li>需长久保存的数据，可以使用AOF持久化方法</li>
<li>过程：会先将命令加到缓存区中，在每次结束时间循环之前，调用<code>flushAppendOnlyFile</code>函数，查配置文件中的同步频率判断是否添加到aof文件</li>
<li>同步频率<ul>
<li><code>appendfsync always</code>：每一个事件循环结束后，都写入aof文件，进行同步 —— 虽然安全，但是低效</li>
<li><code>appendfsync  everysec</code>：写入文件，且每秒进行同步</li>
<li><code>appendfsync  no</code>：写入，但不进行同步</li>
</ul>
</li>
<li>重写降重 <code>rewrite</code> <ul>
<li>不是对aof文件进行读或写操作，而是新建aof文件，读取数据库状态</li>
<li>通过合并命令进行重写</li>
<li>手动触发：<code>BGREWRITEAOF</code>命令（fork子进程重写）</li>
<li>自动触发：达到上次重写后的文件大小的2倍且&gt;&#x3D;64MB时（可设置）</li>
<li>fork子进程后，主进程收到的写命令暂存在重写的缓存区（不是持久化的缓存区）；子进程完成重写后，发送信号给主进程（主进程阻塞写命令），主进程将重写缓存区（保存数据库状态的一致性）中的命令写入新的aof文件后替换之前的aof文件。</li>
</ul>
</li>
<li>aof文件有损坏时<ul>
<li>redis服务重启时会读取持久化文件进行数据同步，如果aof文件有损坏则会拒绝加载</li>
<li>及时备份 → 使用<code>redis-check-aof --fix 文件名</code> 命令修复 → <code>diff-u</code>对比原文件以及修复后的文件 → 重启服务</li>
</ul>
</li>
</ul>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><ul>
<li>流程：<ol>
<li>从机连接上主机后，请求数据同步</li>
<li>主机进行持久化（RDB方式）</li>
<li>主机将持久化后的RDB文件发送给从机</li>
<li>从机进行同步操作</li>
</ol>
</li>
<li>哨兵模式（Sentinel）<ul>
<li>slave-priority设置</li>
</ul>
</li>
</ul>
<h1 id="应用问题"><a href="#应用问题" class="headerlink" title="应用问题"></a>应用问题</h1><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><ul>
<li>查缓存没有结果，查询数据库也没有结果，同步缓存不成功，导致一直查数据库，进而数据库崩溃</li>
<li>解决：<ul>
<li>将查询数据库返回为空的结果也作为缓存存储，设置较短的失效时间</li>
<li>设置可访问服务的名单（bitmaps类型，id作为偏移量）</li>
<li>布隆过滤器：检索集合中是否存在元素 —— 将所有可能的元素的hash存在bitmaps中（判断存在时有可能实际不存在，但是判断不存在时，肯定不存在）</li>
<li>实时监控：缓存命中率开始大幅度下降时，进行排查并且设置黑名单</li>
</ul>
</li>
</ul>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><ul>
<li>热点数据的缓存过期，导致大量查询落到数据库上，访问压力大</li>
<li>解决：<ul>
<li>高峰访问前，将热点key提前存入缓存当中，并延长失效时间</li>
<li>实时调整key的失效时间</li>
<li>锁：redis返回空时，设置排他锁，只允许一个线程查询数据库，其余进行休眠，隔段时间查询redis，若仍为空，则抢锁</li>
</ul>
</li>
</ul>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><ul>
<li>大量key同时过期，查询数据库的请求过多，服务器崩溃</li>
<li>解决：<ul>
<li>构建多级缓存：nginx缓存+redis缓存+其他（ehcache等）</li>
<li>锁 &#x2F; 队列：保证不会有大量线程并发访问数据库（高并发情况不适用）</li>
<li>设置过期标志更新缓存：记录缓存是否过期，过期触发另外的线程更新缓存</li>
<li>分散key的过期时间：可以设置失效时间+随机值 —— 降低过期时间重复率</li>
</ul>
</li>
</ul>
<h2 id="分布式锁（redis实现）"><a href="#分布式锁（redis实现）" class="headerlink" title="分布式锁（redis实现）"></a>分布式锁（redis实现）</h2><blockquote>
<p>实现方式：数据库 &#x2F; 缓存（redis） &#x2F; zookeeper（redis性能最佳，zookeeper可靠性最好）</p>
</blockquote>
<ul>
<li>setnx上锁：锁也是一个key，线程执行业务逻辑前，先setnx（存在就不可以建，对应锁只能有一个）一个lock，创建成功（拿到锁）后执行业务</li>
</ul>
<blockquote>
<p>问题1：lock过期了但线程A并未结束业务，此时被等待中的线程B拿到lock，而A结束后释放锁，但此时锁在B，导致释放了B的锁</p>
</blockquote>
<p>解决：使用uuid给服务器指定不同的锁值，释放前判断当前时刻lock对应的value（uuid）与自己的uuid是否一致，一致才能释放</p>
<blockquote>
<p>问题2：线程A完成业务并且验证uuid后，准备释放锁时，锁过期且刚好被B抢到锁，此时A进行释放锁的操作</p>
</blockquote>
<p>解决：lua脚本可保证原子性，线程结束业务（包括释放锁）前阻塞其他线程</p>
<ul>
<li>确保锁可用的条件：<ul>
<li>互斥性：任一时刻，仅有一个客户端持有锁</li>
<li>不会发生死锁</li>
<li>加锁解锁由同一客户端完成，且有原子性</li>
</ul>
</li>
</ul>
<h1 id="Redis6特性"><a href="#Redis6特性" class="headerlink" title="Redis6特性"></a>Redis6特性</h1><ul>
<li>ACL —— 用户权限等</li>
<li>IO多线程 —— 执行命令还是单线程，多线程指的是网络数据的读写和协议解析（默认不开启）</li>
<li>支持cluster集群</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">LLoyyj</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://lloyyj.github.io/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://lloyyj.github.io/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/18/Spring/"><img class="prev-cover" src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Spring</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/18/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/"><img class="next-cover" src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">算法题解题思路</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://s2.loli.net/2023/01/11/1NsbGvmfukWXBQM.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">LLoyyj</div><div class="author-info__description">属于我人生的一小步</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/LLoyyJ"><i class="fab fa-github"></i><span>关注我一下下？</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">你自己偷偷知道就好啦 ~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%EF%BC%88%E5%8D%95%E8%BF%9B%E7%A8%8B%E5%8D%95%E7%BA%BF%E7%A8%8B%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">Redis（单进程单线程）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDB-amp-AOF%E6%9C%BA%E5%88%B6"><span class="toc-number">1.0.1.</span> <span class="toc-text">RDB &amp; AOF机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E9%94%AE%E7%9A%84%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"><span class="toc-number">1.0.2.</span> <span class="toc-text">过期键的删除策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.0.3.</span> <span class="toc-text">线程模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">1.0.4.</span> <span class="toc-text">缓存雪崩、缓存穿透、缓存击穿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94%E4%BF%9D%E8%AF%81ACID"><span class="toc-number">1.0.5.</span> <span class="toc-text">事务实现——保证ACID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88"><span class="toc-number">1.0.6.</span> <span class="toc-text">Redis集群方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.</span> <span class="toc-text">命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%86%B2%E7%AA%81"><span class="toc-number">2.2.</span> <span class="toc-text">事务冲突</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81-amp-%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">2.3.</span> <span class="toc-text">悲观锁&amp;乐观锁</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB"><span class="toc-number">3.1.</span> <span class="toc-text">RDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF"><span class="toc-number">3.2.</span> <span class="toc-text">AOF</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">4.</span> <span class="toc-text">集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">主从复制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">应用问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">5.1.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">5.2.</span> <span class="toc-text">缓存击穿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">5.3.</span> <span class="toc-text">缓存雪崩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88redis%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">分布式锁（redis实现）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis6%E7%89%B9%E6%80%A7"><span class="toc-number">6.</span> <span class="toc-text">Redis6特性</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/18/Spring/" title="Spring"><img src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring"/></a><div class="content"><a class="title" href="/2023/04/18/Spring/" title="Spring">Spring</a><time datetime="2023-04-18T03:27:49.000Z" title="Created 2023-04-18 11:27:49">2023-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Redis学习笔记"><img src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis学习笔记"/></a><div class="content"><a class="title" href="/2023/04/01/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Redis学习笔记">Redis学习笔记</a><time datetime="2023-04-01T03:27:41.000Z" title="Created 2023-04-01 11:27:41">2023-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/18/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/" title="算法题解题思路"><img src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法题解题思路"/></a><div class="content"><a class="title" href="/2023/01/18/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/" title="算法题解题思路">算法题解题思路</a><time datetime="2023-01-18T08:43:39.000Z" title="Created 2023-01-18 16:43:39">2023-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/14/%E9%9D%A2%E8%AF%95%E5%85%AB%E8%82%A1/" title="面试八股"><img src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试八股"/></a><div class="content"><a class="title" href="/2023/01/14/%E9%9D%A2%E8%AF%95%E5%85%AB%E8%82%A1/" title="面试八股">面试八股</a><time datetime="2023-01-14T07:27:59.000Z" title="Created 2023-01-14 15:27:59">2023-01-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/13/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="MySQL学习笔记（一）"><img src="https://s2.loli.net/2023/01/11/IgN6lKQZ2kBHbev.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL学习笔记（一）"/></a><div class="content"><a class="title" href="/2023/01/13/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="MySQL学习笔记（一）">MySQL学习笔记（一）</a><time datetime="2023-01-13T03:27:23.000Z" title="Created 2023-01-13 11:27:23">2023-01-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> LLoyyj</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">开心就好<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="7427714271" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script data-pjax defer src="https://npm.elemecdn.com/tzy-blog/lib/js/theme/chocolate.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>